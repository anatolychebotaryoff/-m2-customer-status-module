<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://www.magentocommerce.com/license/enterprise-edition
 */
?>

<?php
/**
 * @see Mage_Catalog_Block_Product_View
 */
$_product = $this->getProduct();
$_tierPrices = Mage::getBlockSingleton('catalog/product_price')->getTierPrices($_product); 
$_finalPriceInclTax = $this->helper('tax')->getPrice($_product, $_product->getFinalPrice(), true);

/** @var $_catalogHelper Mage_Catalog_Helper_Data */
$_catalogHelper = Mage::helper('catalog');

$_weeeTaxAmount = Mage::helper('weee')->getAmountForDisplay($_product);
if (Mage::helper('weee')->typeOfDisplay($_product, array(1,2,4))) {
    $_weeeTaxAttributes = Mage::helper('weee')->getProductWeeeAttributesForDisplay($_product);
}

?>
<?php
// There is an issue with hotdeal price and tier price.
// When the hot deal price is lower than tier price, the tier price
// is zero and it shows the tier price block with + in the quantity field
// and $0.00 in the price field.  In order to remove that, the following
// if condition is necessary [the first if condition].
?>
<?php if (count($_tierPrices) > 0): ?>
<?php if($_product->getTierPrice()): ?>
    <div class="price-discount">
        <table class="content-prices">
            <thead>
                <tr>
                    <th>Quantity</th>
                    <th class="price">Unit Price</th>
                </tr>
            </thead>
            <tbody>
                <?php
                $count = count($_tierPrices);
                $i = 1;
                foreach($_tierPrices as $_tierPrice){
                    if($i == 1) {
                        $from[$i] = ($_tierPrice['price_qty'] <= 2) ? 2:$_tierPrice['price_qty'];
                        $priceT[$i] = $_tierPrice['price'];
                    }else{
                        $from[$i] = $_tierPrice['price_qty'];
                        $to[$i - 1] = $_tierPrice['price_qty'] - 1;
                        $priceT[$i] = $_tierPrice['price'];
                    }
                    $i++;
                }
                if($count > 1):
                    for($j = 0; $j <= $count ; $j++):
                        if($j == 0):
                            ?>
                            <tr>
                                <td>
                                    <span class="qty">
                                        <?php if($from[$j+1] == 2){
                                            echo '1';
                                        }

                                        else{
                                            echo '1 - '.($from[$j+1] - 1);
                                        }
                                        ?>
                                    </span>
                                </td>
                                <td class="price">
                                                <span class="regular-price">
                                                <span class="price"><?php echo sprintf("$%0.2f",$_product->getFinalPrice()); ?></span>
                                                </span>
                                </td>
                            </tr>
                        <?php elseif($j>0 && $j<$count): ?>
                            <tr>
                                <td>
                                    <span class="qty">
                                        <?php
                                        if($from[$j] == $to[$j]){
                                            echo $from[$j];
                                        }else{
                                            echo $from[$j].' - '.$to[$j];
                                        }
                                        ?>
                                    </span>
                                </td>
                                <td class="price">
                                    <span class="regular-price">
                                        <?php if ((int)$_tierPrices[$j-1]['isfixed']) : ?>
                                            <span class="price"><?php echo sprintf("$%0.2f",$priceT[$j]); ?></span>
                                        <?php else: ?>
                                            <span class="price"><?php echo sprintf("$%0.2f",Mage::helper('uswf_bundle')->getPercentagePrice($_product->getFinalPrice(),$priceT[$j])); ?></span>
                                        <?php endif; ?>
                                    </span>
                                </td>
                            </tr>
                        <?php else: ?>
                            <tr class="content">
                                <td>
                                    <span class="qty"><?php echo $_tierPrice['price_qty']; ?> +</span>
                                </td>
                                <td class="price">
                                    <span class="regular-price">
                                        <?php if ((int)$_tierPrices[$j-1]['isfixed']) : ?>
                                            <span class="price"><?php echo sprintf("$%0.2f",$priceT[$j]); ?></span>
                                        <?php else: ?>
                                            <span class="price"><?php echo sprintf("$%0.2f",Mage::helper('uswf_bundle')->getPercentagePrice($_product->getFinalPrice(),$priceT[$j])); ?></span>
                                        <?php endif; ?>
                                    </span>
                                </td>
                            </tr>
                        <?php endif;?>
                    <?php
                    endfor;
                else:
                    ?>
                    <tr>
                        <td>
                            <span class="qty"><?php echo $_tierPrice['price_qty']; ?> +</span>
                        </td>
                        <td class="price">
                            <span class="regular-price">
                                <?php if ((int)$_tierPrices[0]['isfixed']) : ?>
                                    <span class="price"><?php echo sprintf("$%0.2f",$_tierPrice['price']); ?></span>
                                <?php else: ?>
                                    <span class="price"><?php echo sprintf("$%0.2f",Mage::helper('uswf_bundle')->getPercentagePrice($_product->getFinalPrice(),$priceT[1])); ?></span>
                                <?php endif; ?>
                            </span>
                        </td>
                    </tr>
                <?php endif;?>
            </tbody>
        </table>
    </div>
<?php endif; ?>
<?php endif; ?>
