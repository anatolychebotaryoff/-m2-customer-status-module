<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     enterprise_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://www.magentocommerce.com/license/enterprise-edition
 */
/** @var $this Enterprise_TargetRule_Block_Catalog_Product_Item */
$_item = $this->getItem();
$_item_data = $this->getItemData();
$_helperUV = $this->helper('uswf_universalvariable');
$productCategory = $_helperUV->getAttributeValue($_item->getId(), 'item_type');
if ($_item):
?>
<?php $buttonTitle = $this->__('Add to Cart'); $buttonViewTitle = $this->__('View Details'); ?>
<?php if ($_item->getTypeId() == Mage_Catalog_Model_Product_Type::TYPE_BUNDLE): ?>
    <form action="<?php echo $this->helper('checkout/cart')->getAddUrl($_item) ?>" method="post" id="product_addtocart_form<?php echo $_item->getId() ?>">
<?php else: ?>
    <form action="<?php echo $this->getSubmitUrl($_item) ?>" method="post" id="product_addtocart_form<?php echo $_item->getId() ?>">
<?php endif; ?>
    <div class="no-display">
        <input type="hidden" name="product" value="<?php echo $_item->getId() ?>" />
    </div>
    <div class="item-info">
        <a href="<?php echo $this->getProductUrl($_item) ?>" class="product-image" onclick="onProductClick('<?php echo $_item->getSku() ?>', '<?php echo $this->jsQuoteEscape($_item->getName()) ?>', 'Related Products TargetRule', '<?php echo $productCategory ?>' , '<?php echo $_item_data['variant'] ?>', '<?php echo $_item_data['brand'] ?>' );">
            <img src="<?php echo $this->helper('catalog/image')->init($_item, 'small_image')->resize(70) ?>" width="70" height="70" alt="<?php echo $this->escapeHtml($_item->getName()) ?>" title="<?php echo $this->escapeHtml($_item->getName()) ?>" />
        </a>
        <div class="item-info-details">
            <p class="product-name">
                <a href="<?php echo $this->getProductUrl($_item) ?>" onclick="onProductClick('<?php echo $_item->getSku() ?>', '<?php echo $this->jsQuoteEscape($_item->getName()) ?>', 'Related Products TargetRule', '<?php echo $productCategory ?>' , '<?php echo $_item_data['variant'] ?>', '<?php echo $_item_data['brand'] ?>' );"><?php echo $this->escapeHtml($_item->getName()) ?></a>
            </p>
            <div class="product-details">
                <div class="yotpo-bottomLine-wrapper">
                    <span class="hidden yotpo-data" data-url="<?php echo $_item->getProductUrl() ?>"></span>
                    <?php $this->helper('uswf_yotpo')->showBottomline($this, $_item); ?>
                </div>
                <?php echo $this->getPriceHtml($_item, true, '-related') ?>
                <?php if((!$_item->isComposite() && $_item->isSaleable()) ||
                    (in_array($_item->getTypeId(), array(Mage_Catalog_Model_Product_Type::TYPE_BUNDLE, Mage_Catalog_Model_Product_Type::TYPE_GROUPED)) && $_item->isSaleable())): ?>
                    <?php if (!$_item->getRequiredOptions()): ?>
                        <?php if( $_item->getTypeId() === 'grouped' || (int) $_item->getNotForSale() === 1 ): ?>
                            <button type="button" title="<?php echo $buttonViewTitle ?>" class="button btn-cart" onclick="onProductClick('<?php echo $_item->getSku() ?>', '<?php echo $this->jsQuoteEscape($_item->getName()) ?>', 'Related Products TargetRule', '<?php echo $productCategory ?>' , '<?php echo $_item_data['variant'] ?>', '<?php echo $_item_data['brand'] ?>' );setLocation('<?php echo $this->getProductUrl($_item); ?>')"><span><span><?php echo $buttonViewTitle ?></span></span></button>
                        <?php else: ?>
                            <button type="button" title="<?php echo $buttonTitle; ?>" class="button btn-cart" onclick="onAddToCart('<?php echo $_item->getSku() ?>', '<?php echo $this->jsQuoteEscape($_item->getName()) ?>', '<?php echo $_item->getFinalPrice() ?>', '1', '<?php echo $productCategory ?>' , '<?php echo $_item_data['variant'] ?>', '<?php echo $_item_data['brand'] ?>');window.productAddToCartForm<?php echo $_item->getId(); ?>.submit(this)"><span><span><?php echo $buttonTitle; ?></span></span></button>
                        <?php endif; ?>
                    <?php elseif ($_item->getTypeId() == Mage_Catalog_Model_Product_Type::TYPE_BUNDLE): ?>
                        <?php $bundleUrl = '/bundle/cart/add/id/' . $_item->getId(); ?>
                        <button type="button" title="<?php echo $buttonTitle ?>" class="button btn-cart" onclick="onAddToCart('<?php echo $_item->getSku() ?>', '<?php echo $this->jsQuoteEscape($_item->getName()) ?>', '<?php echo $_item->getFinalPrice() ?>', '1', '<?php echo $productCategory ?>' , '<?php echo $_item_data['variant'] ?>', '<?php echo $_item_data['brand'] ?>');window.productAddToCartForm<?php echo $_item->getId() ?>.submit(this, '<?php echo $bundleUrl; ?>')"><span><span><?php echo $buttonTitle ?></span></span></button>
                        <div class="no-display">
                            <input type="hidden" name="product" value="<?php echo $_item->getId() ?>" />
                            <input type="hidden" name="related_product" id="related-products-field" value="" />
                        </div>
                        <?php if ($_item->isSaleable() && $_item->getTypeInstance(true)->hasOptions($_item)): ?>
                            <?php $origProduct = Mage::registry('product'); Mage::unregister('product') ?>
                            <?php Mage::register('product', $_item) ?>
                            <div id="options-container" style="display:none">
                                <div id="customizeTitle" class="page-title title-buttons">
                                </div>
                                <?php echo $this->getChildHtml('bundleSummary') ?>
                                <?php if ($this->getChildChildHtml('container1')):?>
                                    <?php echo $this->getChildChildHtml('container1', '', true, true) ?>
                                <?php elseif ($this->getChildChildHtml('container2')):?>
                                    <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
                                <?php endif;?>
                            </div>
                            <?php Mage::unregister('product'); Mage::register('product', $origProduct) ?>
                        <?php endif; ?>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        //<![CDATA[
        addEvent(window, 'load', function() {
            window.productAddToCartForm<?php echo $_item->getId() ?> = new VarienForm('product_addtocart_form<?php echo $_item->getId() ?>');
            window.productAddToCartForm<?php echo $_item->getId() ?>.submit = function (button, url) {
                if (this.validator.validate()) {
                    var form = this.form;
                    var oldUrl = form.action;

                    if (url) {
                        form.action = url;
                    }
                    var e = null;
                    try {
                        this.form.submit();
                    } catch (e) {
                    }
                    this.form.action = oldUrl;
                    if (e) {
                        throw e;
                    }

                    if (button && button != 'undefined') {
                        button.disabled = true;
                    }
                }
            }.bind(window.productAddToCartForm<?php echo $_item->getId() ?>);

            window.productAddToCartForm<?php echo $_item->getId() ?>.submitLight = function (button, url) {
                if (this.validator) {
                    var nv = Validation.methods;
                    delete Validation.methods['required-entry'];
                    delete Validation.methods['validate-one-required'];
                    delete Validation.methods['validate-one-required-by-name'];
                    // Remove custom datetime validators
                    for (var methodName in Validation.methods) {
                        if (methodName.match(/^validate-datetime-.*/i)) {
                            delete Validation.methods[methodName];
                        }
                    }

                    if (this.validator.validate()) {
                        if (url) {
                            this.form.action = url;
                        }
                        this.form.submit();
                    }
                    Object.extend(Validation.methods, nv);
                }
            }.bind(window.productAddToCartForm<?php echo $_item->getId() ?>);
        });
        //]]>
    </script>
</form>
<?php endif;?>
