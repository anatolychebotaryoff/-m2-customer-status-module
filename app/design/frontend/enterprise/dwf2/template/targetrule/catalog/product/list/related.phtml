<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     enterprise_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://www.magentocommerce.com/license/enterprise-edition
 */
/* @var $this Enterprise_TargetRule_Block_Catalog_Product_List_Related */


// Enhanced Google Ecommerce Variables
$currentPosition = 1;
$_helperUV = $this->helper('uswf_universalvariable');
$related_product_data = array();

?>
<?php if ($this->hasItems()): ?>
<?php
    foreach($this->getItemCollection() as $_item) { 

        $package_qty = $_item->getPackageQty(); 
        if (is_numeric($package_qty) && (int)$package_qty != 1) { 
            $variant = $package_qty.'pk'; 
        } else {
            $variant = 'single';
        }
        $brand = $_item->getAttributeText('manufacturer'); 
        $productCategory = $_helperUV->getAttributeValue($_item->getId(), 'item_type') ;
        $_item_data = array (
            'variant' => $variant,
            'brand' => $brand,
            'category' => $productCategory
        ); 

        $product_data = array(

            'item_url' => $_item->getProductUrl(),
            'title' => $this->jsQuoteEscape($this->escapeHtml($_item->getName())),
            'onclick' => "onProductClick('{$_item->getSku()}', '{$this->jsQuoteEscape($_item->getName())}', 'Related Products', '{$productCategory}', '{$variant}', '{$brand}')",
            'img_url' => (string)$this->helper('catalog/image')->init($_item, 'thumbnail')->resize(240),
            'price' => '$' . number_format($_item->getFinalPrice(), 2),
            'price_html' => $this->getPriceHtml($_item, true, '-related'),
            'reviews' => '<div class="yotpo bottomLine" data-product-id="'.$_item->getEntityId().'" data-name="'.$_item->getName().'" data-url="'.$_item->getProductUrl().'" data-image-url="'.(string)$this->helper('catalog/image')->init($_item, 'thumbnail')->resize(240).'" data-description="'.$_item->getDescription().'"></div>',
        );

        if ($_item->getMsrp() > 0) {
            $product_data["msrp"] = Mage::helper('core')->currency($_item->getMsrp());
        }

        $related_product_data[] = $product_data;
    }
?>

                <script type="text/javascript">
                    try {
                        ga('ec:addImpression', {
                            'id'        :   '<?php echo $_item->getSku() ?>',
                            'name'      :   '<?php echo $this->jsQuoteEscape($_item->getName()) ?>',
                            'list'      :   'Related Products TargetRule',
                            'category'  :   '<?php echo $productCategory ?>',
                            'brand'     :   '<?php echo $brand ?>',
                            'variant'   :   '<?php echo $variant ?>',
                            'position'  :   '<?php echo $currentPosition++ ?>'
                        });
                    } catch (e) {}

var j_related_product = j_related_product || new Object();
j_related_product.items = <?php echo json_encode($related_product_data); ?>;
                try {
                    ga('send', 'event', 'catalog', 'impression', {'nonInteraction': true});

                } catch (e) {}
            addEvent(window, 'load', function(){ decorateGeneric($$('.box-related ul.box-content'), ['odd','even','first','last']); });</script>
<?php endif; ?>
