<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_modern
 * @copyright   Copyright (c) 2010 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 */
?>
<?php $_helper = $this->helper( 'catalog/output' ); ?>
<?php $product = Mage::registry( 'current_product' ); ?>
<?php $_product = Mage::getModel( 'catalog/product' )->load( $product->getId() );//$this->getProduct(); ?>
<?php $_noLongerSold = $_product->getNotForSale(); ?>
<?php $_description = $_product->getDescription(); ?>
<?php $_noLongerSoldDescr = $_product->getNotForSaleDescr() ?>
<?php $compatibleList = Mage::helper( 'uswf_catalog' )->getProductCompatibleList( $_product ); ?>
<?php $_helperLinksCatalog = $this->helper( 'uswf_linkscatalog' ); ?>

<?php
$_specAttributes = array();
$_specsTabHtml   = '';
if ( $_product->getHasSpecs() ) {
	// try to get spec html
	$_specsTabHtml = trim( $_helper->productAttribute( $_product, $_product->getSpecsTabHtml(), 'specs_tab_html' ) );
}

if ( ! $_specsTabHtml ) {
	// get attributes if we don't have html for spec tab
	$attributesCollection = Mage::getResourceModel( 'catalog/product_attribute_collection' );
	$attributesCollection->setAttributeGroupFilter( 37 );
	foreach ( $attributesCollection as $attribute ) {
		if ( ! $attribute->getIsVisibleOnFront() ) {
			continue;
		}

		$valLabel = $_product->getResource()->getAttribute( $attribute->getAttributeCode() )->getFrontendLabel();
		$valReal  = $_product->getData( $attribute->getAttributeCode() );
		$valAttr  = $_product->getResource()->getAttribute( $attribute->getAttributeCode() )->getFrontend()->getValue( $_product );
		if ( $valReal && $valAttr != '' ) {
			$_specAttributes[ $attribute->getAttributeCode() ] = array(
				'label' => $this->escapeHtml( $valLabel ),
				'value' => $valAttr,
				'code'  => $attribute->getAttributeCode()
			);
		}
	}
}

$_showSpecsTab = ( ! empty( $_specsTabHtml ) || ! empty( $_specAttributes ) );
?>
<div id="pdp--tabs">
	<ul class="product-tabs rulo">
		<?php if ( $this->getChildHtml( 'description' ) != '' ): ?>
			<li id="product_tabs_contaminants" class="active first">
				<a href="#"><?php echo 'Product Information (How It Works)' ?></a>
			</li>
		<?php endif; ?>
		<?php if ( $_product->getHasInstructions() || $_product->getHasResetInstr() || $_product->getVideoUrl() ): ?>
			<li id="product_tabs_instructions">
				<a href="#"><?php echo 'Installation and FAQ\'s' ?></a>
			</li>
		<?php endif; ?>

		<li id="product_tabs_features">
			<a href="#"><?php echo 'Product Specifications' ?></a>
		</li>

		<li id="product_tabs_reviews" class="last">
			<a href="#"><?php echo $this->__( 'Reviews' ); ?></a>
		</li>
	</ul>
	<div class="clear"></div>

	<?php /////// Product Information (How It Works) //////// ?>
	<?php if ( $this->getChildHtml( 'description' ) != '' ): ?>
		<div class="box-collateral product-tabs-content" id="product_tabs_contaminants_contents">
			<?php echo $this->getChildHtml( 'description' ); ?>
		</div>
	<?php endif; ?>

	<?php ////// Installation and FAQ's ////// ?>
	<?php if ( $_product->getHasInstructions() || $_product->getHasResetInstr() || $_product->getVideoUrl() ): ?>
		<div class="box-collateral product-tabs-content" id="product_tabs_instructions_contents">
			<?php if ( $_product->getHasInstructions() ): ?>
				<div class="installation-instructions">
					<h2><?php echo $this->__( 'Instructions' ) ?></h2>
					<?php $instructionsTabHtml = $_product->getInstructionsTabHtml() ?>
					<?php if ( ! empty( $instructionsTabHtml ) ): ?>
						<?php echo $_helper->productAttribute( $_product, $instructionsTabHtml, 'instructions_tab_html' ) ?>
					<?php else: ?>
						<?php $_instrAttributes = array(); ?>
						<?php for ( $i = 0; $i < 10; $i ++ ): ?>
							<?php $_instrAttributes[] = 'instructions_step_' . ( $i + 1 ); ?>
						<?php endfor; ?>
						<?php $attributesCollection = Mage::getResourceModel( 'catalog/product_attribute_collection' ) ?>
						<?php $attributesCollection->addFieldToFilter( 'attribute_code', array( 'in' => $_instrAttributes ) ) ?>
						<ol class="instructions-attributes" style="list-style: decimal; margin-left: 15px;">
							<?php $_instrAttributes = array(); ?>
							<?php foreach ( $attributesCollection as $attribute ): ?>
								<?php $_attributeCode = $attribute->getAttributeCode() ?>
								<?php $valAtrr = $_product->getResource()->getAttribute( $_attributeCode )->getFrontend()->getValue( $_product ) ?>
								<?php if ( ! empty( $valAtrr ) ): ?>
									<?php $_instrAttributes[ str_replace( 'instructions_step_', '', $_attributeCode ) ] = $valAtrr ?>
								<?php endif; ?>
							<?php endforeach; ?>

							<?php $i = 1;
							ksort( $_instrAttributes ) ?>
							<?php foreach ( $_instrAttributes as $key => $_instrAttribute ): ?>
								<li class="<?php echo 'instructions_step_' . $key ?>">
									<?php echo $_instrAttribute ?>
								</li>
							<?php endforeach; ?>
						</ol>
					<?php endif; ?>
				</div>
			<?php endif; ?>

			<?php if ( $_product->getHasResetInstr() ): ?>
				<div class="reset-instruction">
					<h2><?php echo $this->__( 'Resetting Your Filter Change Indicator' ) ?></h2>
					<?php $_resetAttributes = array(); ?>
					<?php for ( $i = 0; $i < 5; $i ++ ): ?>
						<?php $_resetAttributes[] = 'instr_reset_filter_step_' . ( $i + 1 ); ?>
					<?php endfor; ?>
					<?php $attributesCollection = Mage::getResourceModel( 'catalog/product_attribute_collection' ) ?>
					<?php $attributesCollection->addFieldToFilter( 'attribute_code', array( 'in' => $_resetAttributes ) ) ?>

					<ol class="reset-attributes" style="list-style: decimal; margin-left: 15px;">
						<?php $_resetAttributes = array(); ?>
						<?php foreach ( $attributesCollection as $attribute ): ?>
							<?php $_attributeCode = $attribute->getAttributeCode() ?>
							<?php $valAtrr = $_product->getResource()->getAttribute( $_attributeCode )->getFrontend()->getValue( $_product ) ?>
							<?php if ( ! empty( $valAtrr ) ): ?>
								<?php $_resetAttributes[ str_replace( 'instr_reset_filter_step_', '', $_attributeCode ) ] = $valAtrr ?>
							<?php endif; ?>
						<?php endforeach; ?>

						<?php $i = 1;
						ksort( $_resetAttributes ) ?>
						<?php foreach ( $_resetAttributes as $key => $_resetAttribute ): ?>
							<li class="<?php echo 'instr_reset_filter_step_' . $key ?>">
								<?php echo $_resetAttribute ?>
							</li>
						<?php endforeach; ?>
					</ol>
				</div>
			<?php endif; ?>

			<?php if ( $_videoUrl = $_product->getVideoUrl() ): ?>
				<div class="product-video">
					<h2><?php echo $this->__( 'Video' ) ?></h2>
					<div style="text-align: center;">
						<iframe data-src="<?php echo $_videoUrl ?>" width="640" height="480"
								style="float: none !important;"
								frameborder="0" allowfullscreen></iframe>
					</div>
				</div>
			<?php endif; ?>
		</div>
	<?php endif; ?>

	<?php //////// FEATURES TAB /////// ?>
	<div class="box-collateral product-tabs-content" id="product_tabs_features_contents">
		<?php echo $this->getChildHtml( 'tier1difference_block' ); ?>
		<?php echo $this->getChildHtml( 'additional' ); ?>

		<?php if ( $_product->getHasContaminants() ): ?>
			<div class="contaminants">
				<h2><?php echo $this->__( 'Contaminants' ) ?></h2>
				<div class="std"><?php echo $_product->getAttributeText( 'contaminants_header' ) ?>
					<?php $attributesCollection = Mage::getResourceModel( 'catalog/product_attribute_collection' ) ?>
					<?php $attributesCollection->setAttributeGroupFilter( 23 ) ?>
					<ul class="contaminants-attributes">
						<?php foreach ( $attributesCollection as $attribute ): ?>
							<?php $_attributeCode = $attribute->getAttributeCode() ?>
							<?php $valAtrr = $_product->getResource()->getAttribute( $_attributeCode )->getFrontend()->getValue( $_product ) ?>
							<?php if ( $_attributeCode == 'fluoride' && $valAtrr == 'NF' ): ?>
								<?php $attrUrl = $_helperLinksCatalog->getAttrContaminantsUrl( $_attributeCode ); ?>
								<?php if ( ! empty( $attrUrl ) ): ?>
									<?php $attrUrl = Mage::getBaseUrl() . $attrUrl; ?>
									<?php $urlContaminants = "<a class=\"title\" href=\"{$attrUrl}\">fluoride</a>" ?>
								<?php else: ?>
									<?php $urlContaminants = "fluoride" ?>
								<?php endif; ?>
								<?php $last = '<li class="' . $_attributeCode . '">' . "The {$_product->getSku()} does not reduce {$urlContaminants}." . '</li>' ?>
								<?php continue; ?>
							<?php endif; ?>
							<?php if ( ! empty( $valAtrr ) ): ?>
								<li class="<?php echo $_attributeCode ?>">
									<?php $attrUrl = $_helperLinksCatalog->getAttrContaminantsUrl( $_attributeCode ) ?>
									<?php if ( $valAtrr == 1 ): ?>
										<?php if ( ! empty( $attrUrl ) ): ?>
											<a class="title"
											   href="<?php echo Mage::getBaseUrl() . $attrUrl ?>"><?php echo $_product->getResource()->getAttribute( $_attributeCode )->getFrontendLabel() ?> </a>
										<?php else: ?>
											<span class="title"><?php echo $_product->getResource()->getAttribute( $_attributeCode )->getFrontendLabel() ?> </span>
										<?php endif; ?>
									<?php else: ?>
										<span class="value"><?php echo $valAtrr . $this->__( ' of ' ) ?></span>
										<?php if ( ! empty( $attrUrl ) ): ?>
											<a class="title"
											   href="<?php echo Mage::getBaseUrl() . $attrUrl ?>"><?php echo $_product->getResource()->getAttribute( $_attributeCode )->getFrontendLabel() ?> </a>
										<?php else: ?>
											<span class="title"><?php echo $_product->getResource()->getAttribute( $_attributeCode )->getFrontendLabel() ?> </span>
										<?php endif; ?>
									<?php endif; ?>
								</li>
							<?php endif; ?>
						<?php endforeach; ?>
						<?php if ( ! empty( $last ) ): ?>
							<?php echo $last ?>
						<?php endif; ?>
					</ul>
				</div>
			</div>
		<?php endif; ?>

		<?php $compatibleList = Mage::helper( 'uswf_catalog' )->getProductCompatibleList( $_product ); ?>
		<?php if ( count( $compatibleList ) ): ?>
			<div class="compatible std">
				<h2 class="section--title"><?php echo $this->__( 'The %s is comparable with the following part numbers', $_product->getSku() ) ?></h2>
				<div class="table-scroll">
					<table class="data-table" id="box-compatible-table">
						<tbody>
						<?php $_columns = count( $compatibleList ) < 6 ? 1 : ( count( $compatibleList ) < 12 ? 2 : 4 ); ?>
						<?php $_rows = ceil( count( $compatibleList ) / $_columns ) ?>
						<?php $chunks = array_chunk( $compatibleList, $_rows ); ?>
						<?php for ( $i = 0; $i < $_rows; $i ++ ): ?>
							<tr>
								<?php for ( $j = 0; $j < $_columns; $j ++ ): ?>
									<?php $element = array_shift( $chunks[ $j ] ); ?>
									<?php if ( isset( $element['brand'] ) ): ?>
										<td style="border: 0; padding: 8px 20px 8px 20px">
											<b><?php echo $element['brand'] ?></b></td>
									<?php elseif ( isset( $element['part'] ) ): ?>
										<td style="border: 0; padding: 8px 20px 8px 20px"><?php echo $element['part'] ?></td>
									<?php else: ?>
										<td style="border: 0; padding: 8px 20px 8px 20px">&nbsp;</td>
									<?php endif; ?>
								<?php endfor; ?>
							</tr>
						<?php endfor; ?>
						</tbody>
					</table>
				</div>
			</div>
		<?php endif; ?>

		<?php if ( $_replacement = $_product->getSystemModelsShow() ): ?>
			<div class="replacement">
				<h2><?php echo $this->__( 'Fits the Following Model Numbers' ) ?></h2>
				<div>
					<table class="data-table table-noborder" id="box-replacement-table">
						<tbody>
						<?php $_replacement = explode( '|', $_replacement ) ?>
						<?php $_columns = count( $_replacement ) < 6 ? 1 : ( count( $_replacement ) < 12 ? 2 : 4 ); ?>
						<?php $_rows = ceil( count( $_replacement ) / $_columns ) ?>
						<?php for ( $i = 0; $i < $_rows; $i ++ ): ?>
							<tr>
								<?php for ( $j = 0; $j < $_columns; $j ++ ): ?>
									<td><?php echo array_shift( $_replacement ) ?></td>
								<?php endfor; ?>
							</tr>
						<?php endfor; ?>
						</tbody>
					</table>
				</div>
			</div>
		<?php endif; ?>

		<?php if ( $_siteSearch = $_product->getUpcsSitesearch() ): ?>
			<div class="sitesearch-upc">
				<h2><?php echo $this->__( 'Replacement for the Following UPC' ) ?></h2>
				<div>
					<table class="data-table table-noborder" id="box-sitesearch-table">
						<tbody>
						<?php $_siteSearch = explode( '|', $_siteSearch ) ?>
						<?php $_columns = count( $_siteSearch ) < 6 ? 1 : ( count( $_siteSearch ) < 12 ? 2 : 4 ); ?>
						<?php $_rows = ceil( count( $_siteSearch ) / $_columns ) ?>
						<?php for ( $i = 0; $i < $_rows; $i ++ ): ?>
							<tr>
								<?php for ( $j = 0; $j < $_columns; $j ++ ): ?>
									<td><?php echo array_shift( $_siteSearch ) ?></td>
								<?php endfor; ?>
							</tr>
						<?php endfor; ?>
						</tbody>
					</table>
				</div>
			</div>
		<?php endif; ?>
	</div>

	<?php //////// REVIEWS TAB /////// ?>
	<div class="box-collateral product-tabs-content" id="product_tabs_reviews_contents">
		<h2><?php echo $this->__( 'Reviews' ) ?></h2>
		<div id="yotpo-placeholder"></div>
		<?php $this->helper( 'uswf_yotpo' )->showWidget( $this, $_product ); ?>
	</div>

	<script type="text/javascript">
		//<![CDATA[
		addEvent(window, 'load', function () {
			Varien.Tabs = Class.create();
			Varien.Tabs.prototype = {
				initialize: function (selector) {
					var self = this;
					$$(selector + ' a').each(this.initTab.bind(this));
				},

				initTab: function (el) {
					el.href = 'javascript:void(0)';
					if ($(el.parentNode).hasClassName('active')) {
						this.showContent(el);
					}
					el.observe('click', this.showContent.bind(this, el));
				},

				showContent: function (a) {
					var li = $(a.parentNode), ul = $(li.parentNode);
					ul.select('li').each(function (el) {
						var contents = $(el.id + '_contents');
						if (el == li) {
							el.addClassName('active');
							contents.show();
						} else {
							el.removeClassName('active');
							contents.hide();
						}
					});
				}
			}

			pdpTabs = new Varien.Tabs('.product-tabs');

			function firstReview() {
				var reviewTabA = $$('#product_tabs_reviews > a');
				if (reviewTabA.length > 0) {
					pdpTabs.showContent(reviewTabA[0]);
				}
				return true;
			}

			var hash = document.location.hash;
			if (hash == '#customer-reviews' || hash == '#review-form') {
				firstReview();
			}
			new PeriodicalExecuter(function (pe) {
				$$('.yotpo .star-clickable > a').each(function (element) {
					element.on('click', function (event) {
						pdpTabs.showContent($$('#product_tabs_reviews a').first());
					});
				});
				$$('.yotpo.QABottomLine .ask-question').each(function (element) {
					element.on('click', function (event) {
						pdpTabs.showContent($$('#product_tabs_reviews a').first());
						Element.scrollTo($$('.write-question-wrapper')[0]);
					});
				});
				pe.stop();
			}, 0.25);
		});
		//]]>
	</script>
</div>
