<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_modern
 * @copyright   Copyright (c) 2010 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 */
?>
<?php $_helper = $this->helper( 'catalog/output' ); ?>
<?php $product = Mage::registry( 'current_product' ); ?>
<?php $_product = Mage::getModel( 'catalog/product' )->load( $product->getId() );//$this->getProduct(); ?>

<?php if ( $_product->getHasContaminants() ): ?>
	<div class="container">
		<div class="pdp--section pdp--section__contaminants pdp--top-border col-md-12 no-padding">
			<h2 class="section--title"><?php echo $this->__( 'Contaminants' ) ?></h2>
			<p><b><?php echo $_product->getAttributeText( 'contaminants_header' ) ?></b></p>
			<?php $attributesCollection = Mage::getResourceModel( 'catalog/product_attribute_collection' ) ?>
			<?php $attributesCollection->setAttributeGroupFilter( 23 ) ?>
			<ul>
				<?php foreach ( $attributesCollection as $attribute ): ?>
					<?php $_attributeCode = $attribute->getAttributeCode() ?>
					<?php $valAtrr = $_product->getResource()->getAttribute( $_attributeCode )->getFrontend()->getValue( $_product ) ?>
					<?php if ( $_attributeCode == 'fluoride' && $valAtrr == 'NF' ): ?>
						<?php $last = '<li class="' . $_attributeCode . '">' . $this->__( 'The %s does not reduce fluoride.', $_product->getSku() ) . '</li>' ?>
						<?php continue; ?>
					<?php endif; ?>
					<?php if ( ! empty( $valAtrr ) ): ?>
						<li class="<?php echo $_attributeCode ?>">
							<?php if ( $valAtrr == 1 ): ?>
								<?php echo $_product->getResource()->getAttribute( $_attributeCode )->getFrontendLabel() ?>
							<?php else: ?>
								<?php echo $valAtrr . $this->__( ' of ' ) ?>
								<?php echo $_product->getResource()->getAttribute( $_attributeCode )->getFrontendLabel() ?>
							<?php endif; ?>
						</li>
					<?php endif; ?>
				<?php endforeach; ?>

			</ul>
		</div> <!-- /.container -->
	</div> <!-- /.contaminants -->
<?php endif; ?>


<?php if ( $_product->getHasInstructions() ): ?>
	<div class="container">
		<div class="pdp--section pdp--section__contaminants pdp--top-border col-md-12 no-padding">
			<h2 class="section--title"><?php echo $this->__( 'Instructions' ) ?></h2>
			<?php $_instrAttributes = array(); ?>
			<?php for ( $i = 0; $i < 10; $i ++ ): ?>
				<?php $_instrAttributes[] = 'instructions_step_' . ( $i + 1 ); ?>
			<?php endfor; ?>
			<?php $attributesCollection = Mage::getResourceModel( 'catalog/product_attribute_collection' ) ?>
			<?php $attributesCollection->addFieldToFilter( 'attribute_code', array( 'in' => $_instrAttributes ) ) ?>
			<ol class="instructions-attributes">
				<?php $_instrAttributes = array(); ?>
				<?php foreach ( $attributesCollection as $attribute ): ?>
					<?php $_attributeCode = $attribute->getAttributeCode() ?>
					<?php $valAtrr = $_product->getResource()->getAttribute( $_attributeCode )->getFrontend()->getValue( $_product ) ?>
					<?php if ( ! empty( $valAtrr ) ): ?>
						<?php $_instrAttributes[ str_replace( 'instructions_step_', '', $_attributeCode ) ] = $valAtrr ?>
					<?php endif; ?>
				<?php endforeach; ?>

				<?php $i = 1;
				ksort( $_instrAttributes ) ?>
				<?php foreach ( $_instrAttributes as $key => $_instrAttribute ): ?>
					<li class="<?php echo 'instructions_step_' . $key ?>">
						<?php echo $i . '. ';
						$i ++; ?>
						<?php echo $_instrAttribute ?>
					</li>
				<?php endforeach; ?>
			</ol>
		</div>
	</div>
<?php endif; ?>

<?php if ( $_product->getHasResetInstr() ): ?>
	<div class="container">
		<div class="pdp--section pdp--section__reset pdp--top-border col-md-12 no-padding">
			<h2 class="section--title"><?php echo $this->__( 'Resetting Your Filter Change Indicator' ) ?></h2>
			<?php $_resetAttributes = array(); ?>
			<?php for ( $i = 0; $i < 5; $i ++ ): ?>
				<?php $_resetAttributes[] = 'instr_reset_filter_step_' . ( $i + 1 ); ?>
			<?php endfor; ?>
			<?php $attributesCollection = Mage::getResourceModel( 'catalog/product_attribute_collection' ) ?>
			<?php $attributesCollection->addFieldToFilter( 'attribute_code', array( 'in' => $_resetAttributes ) ) ?>

			<ol class="reset-attributes">
				<?php $_resetAttributes = array(); ?>
				<?php foreach ( $attributesCollection as $attribute ): ?>
					<?php $_attributeCode = $attribute->getAttributeCode() ?>
					<?php $valAtrr = $_product->getResource()->getAttribute( $_attributeCode )->getFrontend()->getValue( $_product ) ?>
					<?php if ( ! empty( $valAtrr ) ): ?>
						<?php $_resetAttributes[ str_replace( 'instr_reset_filter_step_', '', $_attributeCode ) ] = $valAtrr ?>
					<?php endif; ?>
				<?php endforeach; ?>

				<?php $i = 1;
				ksort( $_resetAttributes ) ?>
				<?php foreach ( $_resetAttributes as $key => $_resetAttribute ): ?>
					<li class="<?php echo 'instr_reset_filter_step_' . $key ?>">
						<?php echo $i . '. ';
						$i ++; ?>
						<?php echo $_resetAttribute ?>
					</li>
				<?php endforeach; ?>
			</ol>
		</div>
	</div>
<?php endif; ?>

<?php if ( $_videoUrl = $_product->getVideoUrl() ): ?>
	<div class="container">
		<div class="pdp--section pdp--section__video pdp--top-border col-md-12 no-padding">
			<h2 class="section--title"><?php echo $this->__( 'Video' ) ?></h2>
			<div class="video">
				<iframe data-src="<?php echo $_videoUrl ?>" frameborder="0" allowfullscreen></iframe>
			</div>
		</div>
	</div>
<?php endif; ?>

<?php $compatibleList = Mage::helper( 'uswf_catalog' )->getProductCompatibleList( $_product ); ?>
<?php if ( count( $compatibleList ) ): ?>
	<div class="container">
		<div class="pdp--section pdp--section__comparable pdp--top-border col-md-12 no-padding">
			<h2 class="section--title"><?php echo $this->__( 'The %s is comparable with the following part numbers', $_product->getSku() ) ?></h2>
			<div class="table-scroll">
				<table class="data-table" id="box-compatible-table">
					<tbody>
					<?php $_columns = count( $compatibleList ) < 6 ? 1 : ( count( $compatibleList ) < 12 ? 2 : 4 ); ?>
					<?php $_rows = ceil( count( $compatibleList ) / $_columns ) ?>
					<?php $chunks = array_chunk( $compatibleList, $_rows ); ?>
					<?php for ( $i = 0; $i < $_rows; $i ++ ): ?>
						<tr>
							<?php for ( $j = 0; $j < $_columns; $j ++ ): ?>
								<?php $element = array_shift( $chunks[ $j ] ); ?>
								<?php if ( isset( $element['brand'] ) && isset( $element['part'] ) ): ?>
									<td style="border: 0; padding: 8px 20px 8px 20px">
										<b><?php echo $element['brand'] ?></b></td>
								<?php elseif ( isset( $element['part'] ) ): ?>
									<td style="border: 0; padding: 8px 20px 8px 20px"><?php echo $element['part'] ?></td>
								<?php endif; ?>
							<?php endfor; ?>
						</tr>
					<?php endfor; ?>
					</tbody>
				</table>
			</div>
		</div>
	</div>
<?php endif; ?>

<?php if ( $_replacement = $_product->getSystemModelsShow() ): ?>
	<div class="container">
		<div class="pdp--section pdp--section__compatible pdp--top-border col-md-12 no-padding">
			<h2 class="section--title"><?php echo $this->__( 'Fits the Following Model Numbers' ) ?></h2>
			<div class="table-scroll">
				<table class="data-table table-noborder" id="box-replacement-table">
					<tbody>
					<?php $_replacement = explode( '|', $_replacement ) ?>
					<?php $_columns = count( $_replacement ) < 6 ? 1 : ( count( $_replacement ) < 12 ? 2 : 4 ); ?>
					<?php $_rows = ceil( count( $_replacement ) / $_columns ) ?>
					<?php for ( $i = 0; $i < $_rows; $i ++ ): ?>
						<tr>
							<?php for ( $j = 0; $j < $_columns; $j ++ ): ?>
								<td style="border: 0; padding: 8px 20px 8px 20px"><?php echo array_shift( $_replacement ) ?></td>
							<?php endfor; ?>
						</tr>
					<?php endfor; ?>
					</tbody>
				</table>
			</div>
		</div>
	</div>
<?php endif; ?>

<?php if ( $_siteSearch = $_product->getUpcsSitesearch() ): ?>
	<div class="container">
		<div class="pdp--section pdp--section__compatible pdp--top-border col-md-12 no-padding">
			<h2 class="section--title"><?php echo $this->__( 'Replacement for the Following UPC' ) ?></h2>
			<table class="data-table" id="box-sitesearch-table">
				<tbody>
				<?php $_siteSearch = explode( '|', $_siteSearch ) ?>
				<?php $_columns = count( $_siteSearch ) < 6 ? 1 : ( count( $_siteSearch ) < 12 ? 2 : 4 ); ?>
				<?php $_rows = ceil( count( $_siteSearch ) / $_columns ) ?>
				<?php for ( $i = 0; $i < $_rows; $i ++ ): ?>
					<tr>
						<?php for ( $j = 0; $j < $_columns; $j ++ ): ?>
							<td style="border: 0; padding: 8px 20px 8px 20px"><?php echo array_shift( $_siteSearch ) ?></td>
						<?php endfor; ?>
					</tr>
				<?php endfor; ?>
				</tbody>
			</table>
		</div>
	</div>
<?php endif; ?>
<div class="container">
	<div class="pdp--section pdp--section__compatible pdp--top-border col-md-12 no-padding">
		<div id="customer-reviews-yotpo" class="box-collateral box-reviews">
			<div id="yotpo-placeholder"></div>
			<?php $this->helper( 'uswf_yotpo' )->showWidget( $this, $_product ); ?>
		</div>
	</div>
</div>


