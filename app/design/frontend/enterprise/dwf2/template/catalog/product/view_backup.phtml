<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_helperUV = $this->helper('uswf_universalvariable'); ?>
<?php $_canShowClass = false; ?>
<?php $_product = $this->getProduct(); ?>
<?php $package_qty = $_product->getPackageQty(); ?>
<?php if (is_numeric($package_qty) && (int)$package_qty != 1) : ?>
    <?php $variant = $package_qty.'pk'; ?>
<?php else : ?>
    <?php $variant = 'single'; ?>
<?php endif; ?>
<?php $brand = ($_product->getAttributeText('manufacturer') ? $this->jsQuoteEscape($_product->getAttributeText('manufacturer')) : null); ?>
<?php $productCategory = $_helperUV->getAttributeValue($_product->getId(), 'item_type'); ?>
<?php $_product_data = array (
        'variant' => $variant,
        'brand' => $brand,
        'category' => $productCategory
      ); 
?>
<?php $_noLongerSold = $_product->getNotForSale() ?>
<?php $_associatedProducts = ($_product->isGrouped() ? $_product->getTypeInstance()->getAssociatedProducts() : array()) ?>
<?php $_hasAssociatedProducts = count($_associatedProducts) > 0; ?>

<script type="text/javascript">
    addEvent(window, 'load', function() {
        window.optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
    });
</script>
<div id="messages_product_view"><?php echo $this->getMessagesBlock()->toHtml() ?></div>
<?php if ($_product->getTypeId() != Mage_Catalog_Model_Product_Type::TYPE_SIMPLE): ?>
    <?php if($_product->getResource()->getAttributeRawValue($_product->getId(), 'subscription_enabled', Mage::app()->getStore())){$_canShowClass = true;} ?>
<?php endif; ?>
<div class="product-view <?php echo ($_canShowClass)? 'pdpSbscribed' : ''; ?>">
    <div class="product-essential">
    <?php if (!$_product->isGrouped()): ?>
    <form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
    <?php endif; ?>
        <div class="no-display">
            <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
            <input type="hidden" name="related_product" id="related-products-field" value="" />
        </div>

        <?php echo $this->getChildHtml('upsell_products') ?>
        <?php echo $this->getChildHtml('qubit_head_css') ?>

        <div class="product-img-box">
            <?php echo $this->getChildHtml('media') ?>
        </div>
        <div class="product-shop">
            <div class="product-name">
                <h1><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></h1>
            </div>

            <div class="cust-title" style="display:none;"></div>
            <script type="text/javascript">
                addEvent(window, 'load', function() {
                    var params = document.location.search.toQueryParams(),
                        custTitle = jQuery('.cust-title');
                    if (params['cust-title'] !== undefined && custTitle.length) {
                        custTitle.text(decodeURIComponent(params['cust-title'].replace(/\+/g, "%20"))).css('display', '');
                    }
                });
            </script>

            <?php if ($_noLongerSold && $_product->getNotForSaleShorDescr()): ?>
                <div class="short-description">
                    <h2><?php echo $this->__('Quick Overview') ?></h2>
                    <div class="std"><?php echo $_helper->productAttribute($_product, nl2br($_product->getNotForSaleShorDescr()), 'not_for_sale_shor_descr') ?></div>
                </div>
            <?php elseif (!$_noLongerSold && $_product->getShortDescription()):?>
                <div class="short-description">
                    <h2><?php echo $this->__('Quick Overview') ?></h2>
                    <div class="std"><?php echo $_helper->productAttribute($_product, nl2br($_product->getShortDescription()), 'short_description') ?></div>
                </div>
            <?php endif;?>

            <?php if ($marketingText = $_product->getMarketingMessage()): ?>
                <div class="marketing-message">
                    <?php echo $marketingText ?>
                </div>
            <?php endif; ?>

            <?php echo $this->getChildHtml('product_type_data') ?>
            <div class="clear"></div>


            <?php if ($_noLongerSold): ?>
                <div class="row-product">
                    <div class="yotpo-bottomLine-wrapper">
                        <?php $this->helper('uswf_yotpo')->showBottomline($this, $_product); ?>
                    </div>
                    <div class="yotpo-QABottomLine-wrapper">
                        <?php $this->helper('uswf_yotpo')->showQABottomline($this, $_product); ?>
                    </div>
                    <?php //echo $this->getReviewsSummaryHtml($_product, false, true)?>
                </div>
                <?php echo $this->getChildHtml('replaced_products') ?>
            <?php elseif (!$this->hasOptions()):?>
                <?php echo $this->getTierPriceHtml() ?>
                <?php echo $this->getChildHtml('extrahint') ?>

                <div class="add-to-box">
                    <?php if($_product->isSaleable()): ?>
                        <?php $this->getChild('addtocart')->setProductData($_product_data); ?>
                        <?php echo $this->getChildHtml('addtocart'); ?>
                        <?php if( $this->helper('wishlist')->isAllow() || $_compareUrl=$this->helper('catalog/product_compare')->getAddUrl($_product)): ?>
                            <span class="or"><?php echo $this->__('OR') ?></span>
                        <?php endif; ?>
                    <?php endif; ?>
                </div>
                <?php echo $this->getChildHtml('extra_buttons') ?>
            <?php endif; ?>
			
			<?php echo $this->getChildHtml('other');?>

            <?php if (!$_noLongerSold): ?>
                <?php if ($_product->isSaleable() && $this->hasOptions()):?>
                    <?php echo $this->getChildChildHtml('container1', '', true, true) ?>
                <?php endif;?>

                <?php echo $this->getChildHtml('alert_urls') ?>
                <?php if ($_product->isSaleable() && $this->hasOptions()):?>
                    <?php echo $this->getChildChildHtml('container2', '', true, true) ?>
                <?php endif;?>

                <?php if ($richSnippet = $this->helper('uswf_yotpo/richSnippets')->getRichSnippet($this)): ?>
		<div itemprop="aggregateRating" itemscope itemtype="http://schema.org/AggregateRating" style="display: none">

		       <span itemprop="ratingValue"><?php echo $richSnippet["average_score"]; ?></span> 
		       <span itemprop="ratingCount"><?php echo $richSnippet["reviews_count"]; ?></span>

		</div>  
                <?php endif; ?>

                <div class="row-product">
                    <div class="yotpo-bottomLine-wrapper">
                        <?php $this->helper('uswf_yotpo')->showBottomline($this, $_product); ?>
                    </div>
                    <div class="yotpo-QABottomLine-wrapper">
                        <?php $this->helper('uswf_yotpo')->showQABottomline($this, $_product); ?>
                    </div>
                    <?php //echo $this->getReviewsSummaryHtml($_product, false, true)?>
                </div>
            <?php endif; ?>
        </div>
    <?php if (!$_product->isGrouped()): ?>
    </form>
    <script type="text/javascript">
    //<![CDATA[
    addEvent(window, 'load', function() {
        window.productAddToCartForm = new VarienForm('product_addtocart_form');
        window.productAddToCartForm.submit = function (button, url) {
            if (this.validator.validate()) {
                var form = this.form;
                var oldUrl = form.action;

                if (url) {
                    form.action = url;
                }
                var e = null;
                try {
                    this.form.submit();
                } catch (e) {
                }
                this.form.action = oldUrl;
                if (e) {
                    throw e;
                }

                if (button && button != 'undefined') {
                    button.disabled = true;
                }
            }
        }.bind(window.productAddToCartForm);

        window.productAddToCartForm.submitLight = function (button, url) {
            if (this.validator) {
                var nv = Validation.methods;
                delete Validation.methods['required-entry'];
                delete Validation.methods['validate-one-required'];
                delete Validation.methods['validate-one-required-by-name'];
                // Remove custom datetime validators
                for (var methodName in Validation.methods) {
                    if (methodName.match(/^validate-datetime-.*/i)) {
                        delete Validation.methods[methodName];
                    }
                }

                if (this.validator.validate()) {
                    if (url) {
                        this.form.action = url;
                    }
                    this.form.submit();
                }
                Object.extend(Validation.methods, nv);
            }
        }.bind(window.productAddToCartForm);
    });
    //]]>
    </script>
    <?php endif; ?>
    </div>

    <div class="product-collateral">
		<?php foreach ($this->getChildGroup('detailed_info', 'getChildHtml') as $alias => $html):?>
			<div class="box-collateral <?php echo "box-{$alias}"?>">
				<?php if ($title = $this->getChildData($alias, 'title')):?>
				
				<h2><?php echo $this->escapeHtml($title); ?></h2>
				<?php endif;?>
				<?php echo $html; ?>
			</div>
		<?php endforeach;?>
        <?php echo $this->getChildHtml('info_tabs') ?>
        <?php echo $this->getChildHtml('product_additional_data') ?>
        <?php echo $this->getChildHtml('advancedreview_custom') ?>
		<?php if (isset($_items) && count($_items)):?>
		<div class="collateral-box dedicated-review-box" id="customer-reviews">
			<?php echo $this->getChildHtml('toolbar') ?>
			<ol style="margin-top:15px;">
				<?php foreach ($_items as $_review):?>
					<li>
						<strong><?php echo $this->escapeHtml($_review->getTitle()) ?></strong> <?php echo $this->__('Review by %s', $this->escapeHtml($_review->getNickname())) ?>
						<table class="ratings-list" cellspacing="0">
							<tbody>
								<?php foreach ($_review->getRatingVotes() as $_vote): ?>
								<tr>
									<td class="label"><strong><?php echo $_vote->getRatingCode() ?></strong></td>
									<td>
										<div class="rating-box">
											<div class="rating" style="width: <?php echo $_vote->getPercent() ?>%;"></div>
										</div>
									</td>
								</tr>
								<?php endforeach; ?>
							</tbody>
						</table>
						<p><?php echo nl2br($this->escapeHtml($_review->getDetail())) ?> <?php echo $this->__('(Posted on %s)', $this->formatDate($_review->getCreatedAt()), 'long') ?></p>
					</li>
				<?php endforeach; ?>
			</ol>
			<?php echo $this->getChildHtml('toolbar') ?>
		</div>
		<?php endif;?>
		
		<div class="box-collateral">
			<?php echo $this->getChildHtml('custom_tab') ?>
		</div>
		<?php $attStuff= $_product->getData(); ?>
		<?php if( !empty( $attStuff['videoid'] ) ): ?>        
			<div class="video-box box-collateral">
				<h2><?php echo $this->__('Video') ?></h2>  
				<div class="box-collateral-content">
					<div class="video">
						 <iframe src="<?php echo $attStuff['videoid']; ?>" frameborder="0" allowfullscreen></iframe>     
				   </div>
				</div>
			  </div>
		<?php endif; ?>
    </div>
</div>

<?php /** Google Enhanced Ecommerce js calls */ ?>
<script type="text/javascript">
    try {
        ga('ec:addProduct', {
            'id'        :   '<?php echo $_product->getSku() ?>',
            'name'      :   '<?php echo $this->jsQuoteEscape($_product->getName()) ?>',
            'category'  :   '<?php echo $productCategory ?>',
            'brand'     :   '<?php echo $brand ?>',
            'variant'   :   '<?php echo $variant ?>'
        });

        ga('ec:setAction', 'detail');
        ga('send', 'event', 'catalog', 'detail', {'nonInteraction': true});
    } catch (e) {}
</script>

<?php /** Delimiter appreas after the content */ ?>
<script type="text/javascript">
    var test = new PeriodicalExecuter(function (pe) {
        if ($$('.yotpo .star-clickable .yotpo-stars .yotpo-icon').length>0) {
            $$('.yotpo-bottomLine-wrapper').first().insert({ 'after' : "<div class='yotpo-delimiter-wrapper'> &nbsp;/&nbsp; </div>" });
            pe.stop();
        }
    }, 0.2);
</script>
