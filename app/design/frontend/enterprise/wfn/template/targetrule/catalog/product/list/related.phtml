<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     enterprise_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://www.magentocommerce.com/license/enterprise-edition
 */
/* @var $this Enterprise_TargetRule_Block_Catalog_Product_List_Related */
?>
<?php
// Enhanced Google Ecommerce Variables
$currentPosition = 1;
$_helperUV = $this->helper('uswf_universalvariable');
?>

<?php if ($this->hasItems()): ?>
    <div class="grid-related">
        <div class="products-grid row-fluid">
            <!--<p class="block-subtitle"><?php /*echo $this->__('Check items to add to the cart or') ?>&nbsp;<a href="#" onclick="selectAllRelated(this); return false;"><?php echo $this->__('select all')*/ ?></a></p>-->
            <div class="title-relate-product">
                <h2 class="title">Related Products, Parts, Accessories</h2>
                <!--            <label>Shop Products</label>-->
            </div>
            <div class="related-product flexslider carousel">
                <ul class="slides">
                    <?php $i = 0; foreach ($this->getItemCollection() as $_item): ?>
                        <?php $package_qty = $_item->getPackageQty(); ?>
                        <?php if (is_numeric($package_qty) && (int)$package_qty != 1) : ?>
                            <?php $variant = $package_qty.'pk'; ?>
                        <?php else : ?>
                            <?php $variant = 'single'; ?>
                        <?php endif; ?>
                        <?php $brand = $_item->getAttributeText('manufacturer'); ?>
                        <?php $productCategory = $_helperUV->getAttributeValue($_item->getId(), 'item_type'); ?>
                        <?php $_item_data = array (
                            'variant' => $variant,
                            'brand' => $brand,
                            'category' => $productCategory
                        );
                        ?>

                        <?php $i++; ?>
                        <li class="item span2">
                            <?php
                            $itemBlock = $this->getChild('catalog.product.related.item')->setItem($_item)->setPosition($i)->setItemData($_item_data);
                            echo $itemBlock->toHtml();
                            ?>
                        </li>
                        <script type="text/javascript">
                            try {
                                ga('ec:addImpression', {
                                    'id'        :   '<?php echo $_item->getSku() ?>',
                                    'name'      :   '<?php echo $this->jsQuoteEscape($_item->getName()) ?>',
                                    'list'      :   'Related Products TargetRule',
                                    'category'  :   '<?php echo $productCategory ?>',
                                    'brand'     :   '<?php echo $brand ?>',
                                    'variant'   :   '<?php echo $variant ?>',
                                    'position'  :   '<?php echo $currentPosition++ ?>'
                                });
                            } catch (e) {}
                        </script>
                    <?php endforeach ?>
                </ul>
            </div>
            <script type="text/javascript">
                try {
                    ga('send', 'event', 'catalog', 'impression', {'nonInteraction': true});
                } catch (e) {}
            </script>
            <script type="text/javascript">
                addEvent(window, 'load', function() {
                    decorateList('block-related', 'none-recursive')
                });
            </script>
        </div>
        <script type="text/javascript">
            //<![CDATA[
                addEvent(window, 'load', function() {
                    $$('.related-checkbox').each(function (elem) {
                        Event.observe(elem, 'click', addRelatedToProduct)
                    });

                    relatedProductsCheckFlag = false;
                    function selectAllRelated(txt) {
                        if (relatedProductsCheckFlag == false) {
                            $$('.related-checkbox').each(function (elem) {
                                elem.checked = true;
                            });
                            relatedProductsCheckFlag = true;
                            txt.innerHTML = "<?php echo $this->__('unselect all') ?>";
                        } else {
                            $$('.related-checkbox').each(function (elem) {
                                elem.checked = false;
                            });
                            relatedProductsCheckFlag = false;
                            txt.innerHTML = "<?php echo $this->__('select all') ?>";
                        }
                        addRelatedToProduct();
                    }

                    function addRelatedToProduct() {
                        var checkboxes = $$('.related-checkbox');
                        var values = [];
                        for (var i = 0; i < checkboxes.length; i++) {
                            if (checkboxes[i].checked) values.push(checkboxes[i].value);
                        }
                        if ($('related-products-field')) {
                            $('related-products-field').value = values.join(',');
                        }
                    }

                    jQuery('.related-product').children('.item').each(function () {
                        if (jQuery(this).find('.price-box').children('span').next('a').hasClass('minimal-price-link')) {
                            jQuery(this).find('.price-box').children('span').addClass('price-ant');
                        }
                    });

                    $jq('.grid-related .flexslider').flexslider({
                        slideshow: false,
                        itemWidth: 190,
                        itemMargin: 15,
                        minItems: 1,
                        maxItems: 5,
                        <?php /*if (count($this->getGalleryImages()) < 5 ) { ?>
                        directionNav: false,
                        <?php }*/ ?>
                        controlNav: false,
                        slideshowSpeed: 3000,
                        animationSpeed: 500,
                        animation: "slide"
                    });
                });
            //]]>
        </script>
    </div>
<?php endif ?>
